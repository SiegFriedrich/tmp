//Server間の通信を処理する場合
using Microsoft.AspNetCore.Mvc;
using commonapi.Models;
using commonapi.Shared;
using Microsoft.AspNetCore.Authorization;

[Authorize]
[ApiController]
[Route("api/sys/server")]
public class SysServerController : ControllerBase
{
    [HttpPost("api-control")]
    public ActionResult PostApiControl([FromBody] Operation operation)
    {
        //共通方法を利用してリクエストのヘッダーをチェック
        CommonUtil.ValidateRequestHeader(Request.Headers, CommonUtil.SERVER);
        if (operation.OperationBusinnesId == "SYSTEM" && operation.Status == "0")
        {
            //共通方法を利用してリスポンスにヘッダーを追加
            CommonUtil.AppendServerResponseHeader(Response, "application/json", "nosniff", "SAMEORIGIN", "ISJF9H92S82HFO9CEDWP03OL63E7T6RFW");
            return Ok(new Operation { OperationBusinnesId = "SYSTEM", Status = "0" });
        }
        return Unauthorized();
    }
}

using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Extensions.Configuration;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using Moq;
using commonapi.Controllers;
using commonapi.Models;
using commonapi.Shared;
using System.Collections.Generic;

namespace commonapi.Tests
{
    [TestClass]
    public class SysServerControllerTests
    {
        [TestMethod]
        public void PostApiControl_ValidOperation_ReturnsOk()
        {
            // Arrange
            var mockRequestHeaders = new HeaderDictionary(new Dictionary<string, StringValues>
            {
                { "Ocp-Apim-Subscription-Key", "subscription-key-value" },
                { "Content-Type", "application/json" },
                { "X-Request-Id", "request-id-value" },
                { "X-Bank-Code", "bank-code-value" },
                { "X-Store-Number-Dept-Code", "store-dept-code-value" },
                { "X-User-Id", "user-id-value" }
            });

            var mockUserService = new Mock<IUserService>();
            var mockConfiguration = new Mock<IConfiguration>();

            // 创建 SysServerController 并注入模拟的服务和配置
            var controller = new SysServerController(mockUserService.Object, mockConfiguration.Object);
            var mockHttpContext = new Mock<HttpContext>();
            var mockRequest = new Mock<HttpRequest>();
            var mockResponse = new Mock<HttpResponse>();

            mockRequest.SetupGet(r => r.Headers).Returns(mockRequestHeaders);
            mockHttpContext.SetupGet(h => h.Request).Returns(mockRequest.Object);
            mockHttpContext.SetupGet(h => h.Response).Returns(mockResponse.Object);
            controller.ControllerContext = new ControllerContext
            {
                HttpContext = mockHttpContext.Object
            };

            var validOperation = new Operation { OperationBusinnesId = "SYSTEM", Status = "0" };

            // Act
            var result = controller.PostApiControl(validOperation);

            // Assert
            var okResult = result as OkObjectResult;
            Assert.IsNotNull(okResult);
            Assert.AreEqual(StatusCodes.Status200OK, okResult.StatusCode);

            // You can further assert the response headers or content here if needed.
        }
    }
}



C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(20,82): error CS0246: 型または名前空間の名前 'StringValues' が見つかりま
せんでした (using ディレ
クティブまたはアセンブリ参照が指定されていることを確認してください) [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]      
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(22,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(22,48): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(23,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(23,35): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(24,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(24,35): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(25,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(25,34): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(26,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(26,47): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(27,17): error CS1950: コレクション初期化子に最も適しているオーバーロード
 Add メソッド 'Dictionary<st
ring, StringValues>.Add(string, StringValues)' には無効な引数がいくつか含まれています [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(27,32): error CS1503: 引数 2: は 'string' から 'StringValues' へ変換する
ことはできません
[C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
C:\temp\tokensample\tokensample\commonapi.Tests\Tests\ServerReqResTest.cs(34,34): error CS1729: 'SysServerController' には、引数 2 を指定するコン 
ストラクターは含まれてい
ません [C:\temp\tokensample\tokensample\commonapi.Tests\commonapi.Tests.csproj]
